<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Permit Report Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Include jsPDF and jsPDF-AutoTable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Apple-inspired design with unique flair */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #e6f0fa 0%, #f5e6ff 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .header-bar {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: flex-end;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .header-bar span {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            background: linear-gradient(90deg, #007aff, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background: #ffffff;
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        h2 {
            text-align: center;
            color: #1d1d1f;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            background: linear-gradient(90deg, #007aff, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .report-form {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .report-form select {
            padding: 12px 16px;
            font-size: 16px;
            border-radius: 10px;
            border: 1px solid #d2d2d7;
            background-color: #f5f5f7;
            color: #1d1d1f;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            transition: all 0.3s ease;
        }
        .report-form select:focus {
            outline: none;
            border-color: #9b59b6;
            box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.1);
        }
        .report-form button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 10px;
            border: none;
            background: linear-gradient(145deg, #007aff, #9b59b6);
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(155, 89, 182, 0.2);
        }
        .report-form button:hover {
            background: linear-gradient(145deg, #005bb5, #8e44ad);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
        }
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
        }
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e5ea;
            font-size: 14px;
            color: #1d1d1f;
        }
        th {
            background: linear-gradient(145deg, #007aff, #9b59b6);
            color: #ffffff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        th i {
            margin-right: 8px;
            font-size: 12px;
        }
        th:first-child {
            border-top-left-radius: 10px;
        }
        th:last-child {
            border-top-right-radius: 10px;
        }
        tr {
            transition: background-color 0.3s ease;
        }
        tr:nth-child(even) {
            background-color: #f5f5f7;
        }
        tr:hover {
            background-color: #e5e5ea;
        }
        .no-data {
            text-align: center;
            color: #86868b;
            padding: 20px;
            font-size: 16px;
        }
        .back-btn {
            margin-bottom: 20px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 10px;
            border: none;
            background: #d2d2d7;
            color: #1d1d1f;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: #c7c7cc;
            transform: translateY(-2px);
        }
        .hidden {
            display: none;
        }
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .report-form {
                flex-direction: column;
                align-items: center;
            }
            .report-form select, .report-form button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i> Back to Main</button>
    <div class="header-bar">
        <span>Punjab Production</span>
    </div>
    <div class="container">
        <h2>Monthly Permit Report Generator</h2>
        <div class="report-form">
            <select id="monthSelect" required>
                <option value="">Select Month</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
            <select id="yearSelect" required>
                <option value="">Select Year</option>
                <!-- Years will be populated dynamically -->
            </select>
            <button onclick="generateReport()"><i class="fas fa-file-pdf"></i> Generate Report</button>
        </div>
        <div id="reportTable" class="table-container hidden">
            <table>
                <thead>
                    <tr>
                        <th><i class="fas fa-ticket-alt"></i> Permit No.</th>
                        <th><i class="fas fa-home"></i> Unit No.</th>
                        <th><i class="fas fa-user"></i> Visitor Name</th>
                        <th><i class="fas fa-car"></i> License Plate</th>
                        <th><i class="fas fa-car-side"></i> Vehicle Make</th>
                        <th><i class="fas fa-paint-roller"></i> Vehicle Color</th>
                        <th><i class="fas fa-calendar-alt"></i> Issue Date</th>
                        <th><i class="fas fa-calendar-times"></i> Expire Date</th>
                        <th><i class="fas fa-user-shield"></i> Issue Officer</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
        <div id="noDataMessage" class="no-data hidden">No permits found for the selected month.</div>
    </div>

    <script>
        let db;
        let permits = [];

        // Open the same IndexedDB database as the main website
        const request = indexedDB.open('ParkingDB', 4);

        request.onsuccess = function(event) {
            db = event.target.result;
            loadPermitsFromDB();
            populateYearSelect();
        };

        request.onerror = function(event) {
            console.error('IndexedDB error:', event.target.errorCode);
            alert('Failed to connect to the database. Please try again later.');
        };

        // Load permits from IndexedDB
        function loadPermitsFromDB() {
            const transaction = db.transaction(['permits'], 'readonly');
            const store = transaction.objectStore('permits');
            const request = store.getAll();

            request.onsuccess = function() {
                permits = request.result;
            };

            request.onerror = function() {
                console.error('Error loading permits:', request.error);
                alert('Error loading permits. Please try again.');
            };
        }

        // Populate the year dropdown with a range of years (e.g., 2020 to current year)
        function populateYearSelect() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            // Set the current year as default
            yearSelect.value = currentYear;
        }

        // Format date for display (MM/DD/YYYY)
        function displayDate(dateStr) {
            const date = parseDate(dateStr);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }

        // Parse date string (YYYY-MM-DD) to Date object
        function parseDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // Generate the report
        function generateReport() {
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;

            if (!month || !year) {
                alert('Please select both a month and a year.');
                return;
            }

            const selectedMonth = `${year}-${month}`;
            const filteredPermits = permits.filter(p => p.issueMonth === selectedMonth);

            const tableBody = document.getElementById('reportTableBody');
            const reportTable = document.getElementById('reportTable');
            const noDataMessage = document.getElementById('noDataMessage');

            if (filteredPermits.length === 0) {
                reportTable.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            // Display the permits in the table
            tableBody.innerHTML = filteredPermits.map(p => `
                <tr>
                    <td>${p.permitNo}</td>
                    <td>${p.unitNo}</td>
                    <td>${p.visitorName}</td>
                    <td>${p.licensePlate}</td>
                    <td>${p.vehicleMake}</td>
                    <td>${p.vehicleColor}</td>
                    <td>${displayDate(p.issueDate)}</td>
                    <td>${displayDate(p.expireDate)}</td>
                    <td>${p.issueOfficer}</td>
                </tr>
            `).join('');

            reportTable.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            // Generate PDF
            generatePDF(filteredPermits, selectedMonth);
        }

        // Generate PDF using jsPDF and jsPDF-AutoTable
        function generatePDF(permits, selectedMonth) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add "PUNJAB PRODUCTION" header in the top-right corner on each page
            const addHeader = () => {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 123, 255); // Blue color
                doc.text('PUNJAB PRODUCTION', 180, 10, { align: 'right' });
                doc.setLineWidth(0.2);
                doc.setDrawColor(0, 123, 255);
                doc.line(160, 12, 190, 12); // Small underline
            };

            // Add "GATEHOUSE" watermark on each page (behind content)
            const addWatermark = () => {
                doc.setFontSize(60);
                doc.setFont('times', 'italic');
                doc.setTextColor(220, 220, 220); // Very light gray
                doc.setGState(new doc.GState({ opacity: 0.1 })); // 10% opacity
                doc.text('GATEHOUSE', 105, 150, { angle: 45, align: 'center' });
                // Add a subtle shading effect
                doc.setGState(new doc.GState({ opacity: 0.05 }));
                doc.setFillColor(200, 200, 200);
                doc.rect(0, 0, 210, 297, 'F'); // Subtle background shade
                doc.setGState(new doc.GState({ opacity: 1 })); // Reset opacity
            };

            // Add watermark first (so it stays behind the content)
            addWatermark();
            addHeader();

            // Add report title with gradient effect
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 123, 255);
            doc.text(`Monthly Permit Report - ${selectedMonth}`, 14, 25);
            doc.setLineWidth(0.5);
            doc.setDrawColor(155, 89, 182); // Purple accent
            doc.line(14, 27, 70, 27); // Underline with gradient color

            // Add table
            doc.autoTable({
                startY: 35,
                head: [['Permit No.', 'Unit No.', 'Visitor Name', 'License Plate', 'Vehicle Make', 'Vehicle Color', 'Issue Date', 'Expire Date', 'Issue Officer']],
                body: permits.map(p => [
                    p.permitNo,
                    p.unitNo,
                    p.visitorName,
                    p.licensePlate,
                    p.vehicleMake,
                    p.vehicleColor,
                    displayDate(p.issueDate),
                    displayDate(p.expireDate),
                    p.issueOfficer
                ]),
                theme: 'plain',
                headStyles: {
                    fillColor: [0, 123, 255], // Blue header
                    textColor: [255, 255, 255],
                    fontSize: 10,
                    fontStyle: 'bold',
                    font: 'helvetica',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 9,
                    textColor: [33, 33, 33],
                    font: 'times',
                    halign: 'center'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 247] // Light gray for alternate rows
                },
                margin: { top: 35 },
                styles: {
                    cellPadding: 4,
                    lineWidth: 0.2,
                    lineColor: [200, 200, 200],
                    overflow: 'linebreak',
                    cellWidth: 'auto'
                },
                columnStyles: {
                    0: { cellWidth: 20 }, // Permit No.
                    1: { cellWidth: 20 }, // Unit No.
                    2: { cellWidth: 25 }, // Visitor Name
                    3: { cellWidth: 20 }, // License Plate
                    4: { cellWidth: 20 }, // Vehicle Make
                    5: { cellWidth: 20 }, // Vehicle Color
                    6: { cellWidth: 20 }, // Issue Date
                    7: { cellWidth: 20 }, // Expire Date
                    8: { cellWidth: 20 }  // Issue Officer
                },
                didDrawPage: (data) => {
                    // Add watermark and header on each new page
                    addWatermark();
                    addHeader();

                    // Add footer
                    const pageCount = doc.internal.getNumberOfPages();
                    const pageHeight = doc.internal.pageSize.height;
                    doc.setLineWidth(0.1);
                    doc.setDrawColor(200, 200, 200);
                    doc.line(14, pageHeight - 20, 196, pageHeight - 20); // Separator line
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.setFont('helvetica', 'italic');
                    doc.text(`Page ${data.pageNumber} of ${pageCount}`, 190, pageHeight - 10, { align: 'right' });
                    doc.text('© 2025 Rainbow Village Parking | Generated by Punjab Production', 14, pageHeight - 10);
                }
            });

            // Save the PDF
            doc.save(`Permit_Report_${selectedMonth}.pdf`);
        }
    </script>
</body>
</html>