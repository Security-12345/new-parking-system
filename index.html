<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow Parking System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner hidden">
        <i class="fas fa-spinner fa-spin"></i>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1><i class="fas fa-parking"></i> Rainbow Village Parking</h1>
            </div>
            <div class="system-label">Security Management System v2.0</div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <nav class="sidebar-menu">
    <button class="active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
    <button data-section="permits"><i class="fas fa-ticket-alt"></i> Add Permit</button>
    <button data-section="unit-search"><i class="fas fa-search"></i> Permit Record</button>
    <button data-section="report"><i class="fas fa-exclamation-circle"></i> Report Issue</button>
    <button data-section="about"><i class="fas fa-info-circle"></i> About</button>
    <button onclick="window.location.href='index2.html'"><i class="fas fa-book"></i> Site Rules</button>
    <button onclick="window.location.href='report-generator.html'"><i class="fas fa-file-pdf"></i> Generate Report</button>
    <button onclick="window.location.href='analytics.html'"><i class="fas fa-chart-line"></i> Analytics Hub</button>
    <button id="exportDataBtn"><i class="fas fa-download"></i> Export Data</button>
    <button id="importDataBtn"><i class="fas fa-upload"></i> Import Data</button>
</nav>
            <div class="copyright">© 2025 Jagroop Singh<br>All rights reserved</div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="container">
                    <div class="section-header">
                        <h2>Dashboard</h2>
                        <button class="btn-secondary" id="refreshMetricsBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card" title="Total number of permits issued">
                            <i class="fas fa-ticket-alt"></i>
                            <h3>Total Permits</h3>
                            <p id="totalPermits" class="count-up">0</p>
                        </div>
                        <div class="metric-card" title="Permits issued today">
                            <i class="fas fa-ticket-alt"></i>
                            <h3>Today's Permits</h3>
                            <p id="todayPermits" class="count-up">0</p>
                        </div>
                        <div class="metric-card" title="Unresolved issues">
                            <i class="fas fa-exclamation-circle"></i>
                            <h3>Open Issues</h3>
                            <p id="openIssues" class="count-up">0</p>
                        </div>
                        <div class="metric-card" title="Permits expiring within the next 7 days">
                            <i class="fas fa-clock"></i>
                            <h3>Expiring Soon</h3>
                            <p id="expiringSoon" class="count-up">0</p>
                        </div>
                    </div>
                    <div class="updates-section">
    <h3>System Update</h3>
    <div id="updatesList" class="updates-list">
        <div class="update-item">
            <p>The latest update for the Rainbow Parking System has been successfully deployed. All reported issues have been resolved. If you continue to experience any difficulties, please reach out to the admin for further assistance.</p>
            <span>04/04/2025 - Admin</span>
        </div>
    </div>
</div>

                    <div class="nav-grid">
                        <div class="nav-card" data-section="permits">
                            <i class="fas fa-ticket-alt"></i>
                            <h3>Permit Management</h3>
                            <p>Add new visitor parking permits</p>
                        </div>
                        <div class="nav-card" data-section="unit-search">
                            <i class="fas fa-search"></i>
                            <h3>Unit Search</h3>
                            <p>Search permits and check allocations</p>
                        </div>
                        <div class="nav-card" data-section="report">
                            <i class="fas fa-exclamation-circle"></i>
                            <h3>Report Issue</h3>
                            <p>Submit parking-related concerns</p>
                        </div>
                        <div class="nav-card" data-section="about">
                            <i class="fas fa-info-circle"></i>
                            <h3>About</h3>
                            <p>Learn about the system</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Permits Section -->
            <section id="permits" class="section hidden">
                <div class="container">
                    <h2>Permit Management</h2>
                    <p>Create and manage visitor parking permits efficiently</p>
                    <div class="permit-actions">
                        <button class="btn-primary" data-section="form"><i class="fas fa-plus"></i> Add New Permit</button>
                    </div>
                </div>
            </section>

            <!-- Permit Form Section -->
            <section id="form" class="section hidden">
                <div class="container">
                    <div class="form-container">
                        <div class="form-header">
                            <h3 id="formTitle">Add New Parking Permit</h3>
                            <button data-section="permits"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="formError" class="error hidden"></div>
                        <div id="formRemaining" class="info hidden"></div>
                        <form id="permitForm">
                            <input type="hidden" id="editPermitId">
                            <div class="grid form-grid">
                                <div>
                                    <label>Permit No. <span class="tooltip" title="Auto-generated">ℹ</span></label>
                                    <input type="text" id="permitNo" readonly>
                                </div>
                                <div>
                                    <label>Unit No.</label>
                                    <input type="text" id="unitNo" placeholder="1234/A" pattern="^\d{4}/[A-Z]$" required>
                                </div>
                                <div>
                                    <label>Visitor Name</label>
                                    <input type="text" id="visitorName" required>
                                </div>
                                <div>
                                    <label>License Plate</label>
                                    <input type="text" id="licensePlate" required>
                                </div>
                                <div>
                                    <label>Vehicle Make</label>
                                    <select id="vehicleMake" required>
                                        <option value="">Select Make</option>
                                        <option value="Toyota">Toyota</option>
                                        <option value="Honda">Honda</option>
                                        <option value="Ford">Ford</option>
                                        <option value="BMW">BMW</option>
                                        <option value="Mercedes">Mercedes</option>
                                        <option value="Tesla">Tesla</option>
                                        <option value="Volkswagen">Volkswagen</option>
                                        <option value="Hyundai">Hyundai</option>
                                        <option value="Chevrolet">Chevrolet</option>
                                        <option value="Nissan">Nissan</option>
                                        <option value="Audi">Audi</option>
                                        <option value="Kia">Kia</option>
                                        <option value="Subaru">Subaru</option>
                                        <option value="Mazda">Mazda</option>
                                        <option value="Jeep">Jeep</option>
                                        <option value="Porsche">Porsche</option>
                                        <option value="Lexus">Lexus</option>
                                        <option value="Volvo">Volvo</option>
                                        <option value="Dodge">Dodge</option>
                                        <option value="Ram">Ram</option>
                                        <option value="GMC">GMC</option>
                                        <option value="Acura">Acura</option>
                                        <option value="Infiniti">Infiniti</option>
                                        <option value="Mitsubishi">Mitsubishi</option>
                                        <option value="Land Rover">Land Rover</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Vehicle Color</label>
                                    <select id="vehicleColor" required>
                                        <option value="">Select Color</option>
                                        <option value="Black">Black</option>
                                        <option value="White">White</option>
                                        <option value="Silver">Silver</option>
                                        <option value="Blue">Blue</option>
                                        <option value="Red">Red</option>
                                        <option value="Green">Green</option>
                                        <option value="Yellow">Yellow</option>
                                        <option value="Gray">Gray</option>
                                        <option value="Orange">Orange</option>
                                        <option value="Purple">Purple</option>
                                        <option value="Brown">Brown</option>
                                        <option value="Beige">Beige</option>
                                        <option value="Gold">Gold</option>
                                        <option value="Bronze">Bronze</option>
                                        <option value="Pink">Pink</option>
                                        <option value="Teal">Teal</option>
                                        <option value="Metallic Blue">Metallic Blue</option>
                                        <option value="Pearl White">Pearl White</option>
                                        <option value="Matte Black">Matte Black</option>
                                        <option value="Charcoal">Charcoal</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Issue Officer</label>
                                    <select id="issueOfficer" required>
                                        <option value="">Select Officer</option>
                                        <option value="Jagroop">Jagroop</option>
                                        <option value="Melbin">Melbin</option>
                                        <option value="Vivek">Vivek</option>
                                        <option value="Abiy">Abiy</option>
                                        <option value="Zamil">Zamil</option>
                                        <option value="Abir">Abir</option>
                                        <option value="Bhupinder">Bhupinder</option>
                                        <option value="Priotosh">Priotosh</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Issue Date</label>
                                    <input type="date" id="issueDate" required>
                                </div>
                                <div>
                                    <label>Expire Date</label>
                                    <input type="date" id="expireDate" required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" id="resetFormBtn">Reset</button>
                                <button type="button" data-section="permits">Cancel</button>
                                <button type="submit" id="savePermitBtn">Save Permit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Unit Search Section -->
            <section id="unit-search" class="section hidden">
                <div class="container">
                    <h2>Permit Record</h2>
                    <p>Search permits or check remaining allocations</p>
                    <div class="grid">
                        <div class="search-group">
                            <label>Search Permits</label>
                            <div class="search-bar">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchPermits" placeholder="Search by any field...">
                            </div>
                            <select id="searchFilter" title="Filter search results">
                                <option value="all">All Fields</option>
                                <option value="permitNo">Permit No.</option>
                                <option value="unitNo">Unit No.</option>
                                <option value="licensePlate">License Plate</option>
                                <option value="visitorName">Visitor Name</option>
                            </select>
                        </div>
                        <div class="search-group">
                            <label>Check Remaining Permits</label>
                            <div class="search-bar">
                                <i class="fas fa-search"></i>
                                <input type="text" id="unitSearchInput" placeholder="Unit No. (e.g., 1234/A)">
                            </div>
                            <div id="unitSearchResult" class="info hidden"></div>
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn-secondary" id="clearSearchBtn"><i class="fas fa-times"></i> Clear Search</button>
                    </div>
                    <div id="searchResults" class="table-container hidden">
                        <table id="permitsTable">
                            <thead>
                                <tr>
                                    <th>Permit Details</th>
                                    <th>Vehicle Info</th>
                                    <th>Dates</th>
                                    <th>Officer</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="permitsTableBody"></tbody>
                        </table>
                        <div class="pagination">
                            <button id="prevPageBtn" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                            <span id="pageInfo">Page 1</span>
                            <button id="nextPageBtn">Next <i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Report Issue Section -->
            <section id="report" class="section hidden">
                <div class="container">
                    <h2>Report an Issue</h2>
                    <div id="reportForm">
                        <p>Encountered a problem? Let us know:</p>
                        <form id="issueForm">
                            <div class="search-group">
                                <label>Your Name</label>
                                <input type="text" id="reportUsername" placeholder="Enter your name" required>
                            </div>
                            <div class="search-group">
                                <label>Issue Description <span id="charCount">0/500</span></label>
                                <textarea id="issueDescription" placeholder="Describe the issue..." maxlength="500" required></textarea>
                            </div>
                            <button class="btn-primary" type="submit"><i class="fas fa-paper-plane"></i> Submit Issue</button>
                        </form>
                    </div>
                    <div id="adminAuth" class="hidden">
                        <p>Admin access required to manage issues:</p>
                        <div class="search-group">
                            <label>Admin Password</label>
                            <input type="password" id="adminPassword" placeholder="Enter admin password">
                        </div>
                        <button class="btn-primary" id="adminLoginBtn"><i class="fas fa-lock"></i> Login as Admin</button>
                    </div>
                    <div id="adminIssues" class="table-container hidden">
                        <div class="section-header">
                            <h3>Reported Issues (Admin View)</h3>
                            <button class="btn-secondary" id="clearSolvedBtn"><i class="fas fa-trash"></i> Clear Solved Issues</button>
                        </div>
                        <table id="issuesTable">
                            <thead>
                                <tr>
                                    <th>Issue ID</th>
                                    <th>Reported By</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="issuesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- About Section -->
            <section id="about" class="section hidden">
                <div class="container">
                    <h2>About Rainbow Parking System v2.0</h2>
                    <p>Welcome to the <strong>Rainbow Parking System v2.0</strong>, an advanced platform designed to streamline visitor parking management at Rainbow Village. Built with cutting-edge technology, this system empowers security teams with efficient permit issuance, real-time tracking, and robust issue resolution tools.</p>
                    <h3>Key Features</h3>
                    <ul class="feature-list">
                        <li><strong>Smart Permit Issuance</strong>: Auto-generated permit numbers with current-month expiry by default.</li>
                        <li><strong>Enhanced Search</strong>: Filter permits by specific fields for precise results.</li>
                        <li><strong>Data Management</strong>: Export and import data for backups or migrations.</li>
                        <li><strong>Unit Tracking</strong>: Enforce a 7-permit monthly limit per unit.</li>
                        <li><strong>Issue Reporting</strong>: Improved reporting with admin oversight.</li>
                        <li><strong>Persistent Storage</strong>: IndexedDB ensures data reliability across sessions.</li>
                    </ul>
                    <div class="fancy-note">
                        <p>© All rights reserved by Jagroop Singh. A voluntary contribution to Rainbow Village.</p>
                        <p>Contact Jagroop Singh during village visits for support or feedback.</p>
                        <p>Powered by Punjab Production</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <i id="toastIcon" class="fas"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- Hidden File Input for Import -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <!-- JavaScript -->
    <script>
        /** @type {IDBDatabase} */
        let db;
        /** @type {Array<Object>} */
        let permits = [];
        /** @type {Array<Object>} */
        let issues = [];
        /** @type {Array<Object>} */
        let updates = [];
        const isAdmin = () => localStorage.getItem('isAdmin') === 'true';
        const ADMIN_PASSWORD = "3343"; // TODO: Secure in production
        const ITEMS_PER_PAGE = 5;
        let currentPage = 1;
        /** @type {Array<Object>} */
        let filteredPermits = [];
        const MAX_PERMITS_PER_UNIT_PER_MONTH = 7;

        // Utility Functions
        const formatLocalDate = (date) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const displayDate = (dateStr) => {
            const [year, month, day] = dateStr.split('-');
            return `${month}/${day}/${year}`;
        };
        const getLastDayOfMonth = (date) => {
            const d = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            return formatLocalDate(d);
        };
        const showLoadingSpinner = () => document.getElementById('loadingSpinner').classList.remove('hidden');
        const hideLoadingSpinner = () => document.getElementById('loadingSpinner').classList.add('hidden');
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.className = `toast ${type}`;
            document.getElementById('toastIcon').className = `fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`;
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        // Database Operations
        const openDatabase = () => new Promise((resolve, reject) => {
            const request = indexedDB.open('ParkingDB', 5);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('permits')) {
                    const store = db.createObjectStore('permits', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('permitNo', 'permitNo', { unique: true });
                    store.createIndex('licensePlate', 'licensePlate', { unique: false });
                    store.createIndex('unitNo', 'unitNo', { unique: false });
                    store.createIndex('issueMonth', 'issueMonth', { unique: false });
                }
                if (!db.objectStoreNames.contains('issues')) {
                    db.createObjectStore('issues', { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains('updates')) {
                    db.createObjectStore('updates', { keyPath: 'id', autoIncrement: true });
                }
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });

        const loadPermitsFromDB = async () => {
            showLoadingSpinner();
            try {
                const transaction = db.transaction(['permits'], 'readonly');
                const store = transaction.objectStore('permits');
                permits = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result.sort((a, b) => b.id - a.id));
                    request.onerror = () => reject(request.error);
                });
                if (!permits.length) {
                    const now = new Date();
                    const sample = {
                        id: 1, permitNo: "P001", unitNo: "1234/A", visitorName: "John Doe", licensePlate: "ABC123",
                        vehicleMake: "Toyota", vehicleColor: "Blue", issueDate: formatLocalDate(now), expireDate: getLastDayOfMonth(now),
                        issueOfficer: "Jagroop", issueMonth: `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`
                    };
                    permits.push(sample);
                    const writeTransaction = db.transaction(['permits'], 'readwrite');
                    const writeStore = writeTransaction.objectStore('permits');
                    await Promise.all(permits.map(p => new Promise((res, rej) => {
                        const req = writeStore.add(p);
                        req.onsuccess = res;
                        req.onerror = () => rej(req.error);
                    })));
                }
                updateDashboardMetrics();
            } catch (error) {
                console.error('Error loading permits:', error);
                showToast('Error loading permits. Using fallback.', 'error');
                const now = new Date();
                permits = [{
                    id: 1, permitNo: "P001", unitNo: "1234/A", visitorName: "John Doe", licensePlate: "ABC123",
                    vehicleMake: "Toyota", vehicleColor: "Blue", issueDate: formatLocalDate(now), expireDate: getLastDayOfMonth(now),
                    issueOfficer: "Jagroop", issueMonth: `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`
                }];
                updateDashboardMetrics();
            } finally {
                hideLoadingSpinner();
            }
        };

        const loadIssuesFromDB = async () => {
            showLoadingSpinner();
            try {
                const transaction = db.transaction(['issues'], 'readonly');
                const store = transaction.objectStore('issues');
                issues = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                updateDashboardMetrics();
                if (isAdmin()) loadIssuesTable();
            } catch (error) {
                console.error('Error loading issues:', error);
                showToast('Error loading issues.', 'error');
            } finally {
                hideLoadingSpinner();
            }
        };

        const loadUpdatesFromDB = async () => {
            showLoadingSpinner();
            try {
                const transaction = db.transaction(['updates'], 'readonly');
                const store = transaction.objectStore('updates');
                updates = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                if (!updates.length) {
                    const updatesList = document.getElementById('updatesList');
                    updates = Array.from(updatesList.getElementsByClassName('update-item')).map((item, i) => ({
                        id: i + 1, message: item.querySelector('p').textContent, createdAt: item.querySelector('span').textContent
                    }));
                    const writeTransaction = db.transaction(['updates'], 'readwrite');
                    const writeStore = writeTransaction.objectStore('updates');
                    await Promise.all(updates.map(u => new Promise((res, rej) => {
                        const req = writeStore.add(u);
                        req.onsuccess = res;
                        req.onerror = () => rej(req.error);
                    })));
                }
                displayUpdates();
            } catch (error) {
                console.error('Error loading updates:', error);
                showToast('Error loading updates.', 'error');
            } finally {
                hideLoadingSpinner();
            }
        };

        const updateDashboardMetrics = () => {
            const now = new Date();
            const todayStr = formatLocalDate(now);
            const sevenDaysLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const sevenDaysLaterStr = formatLocalDate(sevenDaysLater);
            const metrics = {
                totalPermits: permits.length,
                todayPermits: permits.filter(p => p.issueDate === todayStr).length,
                openIssues: issues.filter(i => i.status !== 'solved').length,
                expiringSoon: permits.filter(p => p.expireDate > todayStr && p.expireDate <= sevenDaysLaterStr).length
            };
            Object.entries(metrics).forEach(([id, value]) => animateCount(id, value));
        };

        const animateCount = (elementId, target) => {
            const element = document.getElementById(elementId);
            let start = parseInt(element.textContent) || 0;
            const duration = 800;
            const increment = (target - start) / (duration / 60);
            const interval = setInterval(() => {
                start += increment;
                if ((increment > 0 && start >= target) || (increment < 0 && start <= target)) {
                    start = target;
                    clearInterval(interval);
                }
                element.textContent = Math.round(start);
            }, 60);
        };

        const getNextPermitNo = async () => {
            try {
                const transaction = db.transaction(['permits'], 'readonly');
                const store = transaction.objectStore('permits');
                const index = store.index('permitNo');
                const cursor = await new Promise((resolve, reject) => {
                    const request = index.openCursor(null, 'prev');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                return cursor ? `P${(parseInt(cursor.value.permitNo.slice(1)) + 1).toString().padStart(3, '0')}` : 'P001';
            } catch (error) {
                console.error('Error getting next permit number:', error);
                return 'P001';
            }
        };

        const updatePermitNo = async () => {
            const now = new Date();
            document.getElementById('permitNo').value = await getNextPermitNo();
            document.getElementById('issueDate').value = formatLocalDate(now);
            document.getElementById('expireDate').value = getLastDayOfMonth(now);
        };

        const showSection = async (sectionId) => {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelectorAll('.sidebar-menu button').forEach(btn => btn.classList.toggle('active', btn.dataset?.section === sectionId));
            if (sectionId === 'form' && !document.getElementById('editPermitId').value) {
                await updatePermitNo();
                document.getElementById('formTitle').textContent = 'Add New Parking Permit';
            }
            if (sectionId === 'unit-search') {
                currentPage = 1;
                searchPermits();
            }
            if (sectionId === 'report') setupReportSection();
            if (sectionId === 'dashboard') displayUpdates();
        };

        const searchPermits = () => {
            const query = document.getElementById('searchPermits').value.toLowerCase().trim();
            const filter = document.getElementById('searchFilter').value;
            filteredPermits = permits.filter(p => {
                if (!query) return true;
                const val = filter === 'all' ? Object.values(p).join(' ').toLowerCase() : p[filter]?.toString().toLowerCase();
                return val?.includes(query);
            }).sort((a, b) => b.id - a.id);
            currentPage = 1;
            loadSearchResults();
        };

        const loadSearchResults = () => {
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginated = filteredPermits.slice(start, end);
            document.getElementById('permitsTableBody').innerHTML = paginated.map(p => `
                <tr>
                    <td>${highlightText(p.permitNo)}<br><span>${highlightText(p.visitorName)} (${highlightText(p.unitNo)})</span></td>
                    <td>${highlightText(p.licensePlate)}<br><span>${highlightText(p.vehicleMake)} - ${highlightText(p.vehicleColor)}</span></td>
                    <td><i class="fas fa-calendar"></i> ${displayDate(p.issueDate)} - ${displayDate(p.expireDate)}</td>
                    <td>${highlightText(p.issueOfficer)}</td>
                    <td><span class="status ${p.expireDate >= formatLocalDate(new Date()) ? 'active' : 'expired'}">${p.expireDate >= formatLocalDate(new Date()) ? 'Active' : 'Expired'}</span></td>
                    <td><button class="btn-primary" onclick="editPermit(${p.id})"><i class="fas fa-edit"></i> Edit</button></td>
                </tr>
            `).join('');
            const totalPages = Math.ceil(filteredPermits.length / ITEMS_PER_PAGE) || 1;
            document.getElementById('searchResults').classList.toggle('hidden', !paginated.length);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
        };

        const highlightText = (text) => {
            const query = document.getElementById('searchPermits').value;
            if (!query || !text) return text || '';
            return text.replace(new RegExp(`(${query})`, 'gi'), '<span class="highlight">$1</span>');
        };

        const prevPage = () => { if (currentPage > 1) loadSearchResults(currentPage--); };
        const nextPage = () => { if (currentPage < Math.ceil(filteredPermits.length / ITEMS_PER_PAGE)) loadSearchResults(currentPage++); };

        const clearSearch = () => {
            document.getElementById('searchPermits').value = '';
            document.getElementById('unitSearchInput').value = '';
            document.getElementById('searchFilter').value = 'all';
            document.getElementById('unitSearchResult').classList.add('hidden');
            filteredPermits = [...permits].sort((a, b) => b.id - a.id);
            currentPage = 1;
            loadSearchResults();
        };

        const checkRemainingPermits = () => {
            const unitNo = document.getElementById('unitSearchInput').value.toUpperCase();
            const regex = /^\d{4}\/[A-Z]$/;
            const resultDiv = document.getElementById('unitSearchResult');
            if (regex.test(unitNo)) {
                const now = new Date();
                const month = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
                const count = permits.filter(p => p.unitNo === unitNo && p.issueMonth === month).length;
                const remaining = MAX_PERMITS_PER_UNIT_PER_MONTH - count;
                resultDiv.textContent = `${remaining} permit${remaining !== 1 ? 's' : ''} remaining for ${month}`;
                resultDiv.classList.remove('hidden');
            } else {
                resultDiv.classList.add('hidden');
            }
        };

        const checkUnit = () => {
            const unitNo = document.getElementById('unitNo').value.toUpperCase();
            const regex = /^\d{4}\/[A-Z]$/;
            const remainingDiv = document.getElementById('formRemaining');
            const errorDiv = document.getElementById('formError');
            const submitBtn = document.getElementById('savePermitBtn');
            const issueDateStr = document.getElementById('issueDate').value || formatLocalDate(new Date());
            const [year, month] = issueDateStr.split('-');
            const issueMonth = `${year}-${month}`;
            const editId = document.getElementById('editPermitId').value;

            if (regex.test(unitNo)) {
                const count = permits.filter(p => p.unitNo === unitNo && p.issueMonth === issueMonth && (!editId || p.id != editId)).length;
                const remaining = MAX_PERMITS_PER_UNIT_PER_MONTH - count;
                remainingDiv.textContent = `${remaining} permit${remaining !== 1 ? 's' : ''} remaining for ${issueMonth}`;
                remainingDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                submitBtn.disabled = remaining <= 0 && !editId;
                if (remaining <= 0 && !editId) {
                    errorDiv.textContent = `Permit limit reached for ${issueMonth}`;
                    errorDiv.classList.remove('hidden');
                }
            } else {
                remainingDiv.classList.add('hidden');
                errorDiv.textContent = 'Invalid unit number (e.g., 1234/A)';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = true;
            }
        };

        const resetForm = async () => {
            document.getElementById('permitForm').reset();
            document.getElementById('editPermitId').value = '';
            document.getElementById('formTitle').textContent = 'Add New Parking Permit';
            await updatePermitNo();
            document.getElementById('formError').classList.add('hidden');
            document.getElementById('formRemaining').classList.add('hidden');
            document.getElementById('savePermitBtn').disabled = false;
        };

        const editPermit = (permitId) => {
            const permit = permits.find(p => p.id === permitId);
            if (!permit) return showToast('Permit not found.', 'error');
            document.getElementById('editPermitId').value = permit.id;
            document.getElementById('formTitle').textContent = 'Edit Parking Permit';
            ['permitNo', 'unitNo', 'visitorName', 'licensePlate', 'vehicleMake', 'vehicleColor', 'issueOfficer', 'issueDate', 'expireDate'].forEach(id => {
                document.getElementById(id).value = permit[id];
            });
            checkUnit();
            showSection('form');
        };

        const submitPermit = async (event) => {
            event.preventDefault();
            const form = document.getElementById('permitForm');
            const editId = document.getElementById('editPermitId').value;
            const data = {
                permitNo: document.getElementById('permitNo').value,
                unitNo: document.getElementById('unitNo').value.toUpperCase(),
                visitorName: document.getElementById('visitorName').value.trim(),
                licensePlate: document.getElementById('licensePlate').value.toUpperCase(),
                vehicleMake: document.getElementById('vehicleMake').value,
                vehicleColor: document.getElementById('vehicleColor').value,
                issueOfficer: document.getElementById('issueOfficer').value,
                issueDate: document.getElementById('issueDate').value,
                expireDate: document.getElementById('expireDate').value,
            };
            const issueDateStr = data.issueDate;
            const [year, month] = issueDateStr.split('-');
            data.issueMonth = `${year}-${month}`;
            if (editId) data.id = parseInt(editId);

            if (!form.checkValidity()) return showToast('All fields are required.', 'error');
            if (!/^\d{4}\/[A-Z]$/.test(data.unitNo)) return showToast('Unit number must be 1234/A format.', 'error');
            if (data.licensePlate.length > 10) return showToast('License plate max 10 characters.', 'error');
            if (data.issueDate >= data.expireDate) return showToast('Expire date must be after issue date.', 'error');
            if (!editId || (editId && permits.find(p => p.id == editId).unitNo !== data.unitNo)) {
                const count = permits.filter(p => p.unitNo === data.unitNo && p.issueMonth === data.issueMonth && (!editId || p.id != editId)).length;
                if (count >= MAX_PERMITS_PER_UNIT_PER_MONTH) return showToast(`Permit limit reached for ${data.unitNo} in ${data.issueMonth}.`, 'error');
            }
            if (permits.some(p => p.licensePlate === data.licensePlate && p.expireDate >= formatLocalDate(new Date()) && (!editId || p.id != editId))) {
                return showToast(`Active permit exists for ${data.licensePlate}.`, 'error');
            }
            if (!confirm(`Confirm ${editId ? 'update' : 'save'} permit for ${data.unitNo}?`)) return;

            showLoadingSpinner();
            try {
                const transaction = db.transaction(['permits'], 'readwrite');
                const store = transaction.objectStore('permits');
                const request = editId ? store.put(data) : store.add(data);
                data.id = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(editId ? data.id : request.result);
                    request.onerror = () => reject(request.error);
                });
                if (editId) permits[permits.findIndex(p => p.id == editId)] = data;
                else permits.unshift(data);
                filteredPermits = [...permits].sort((a, b) => b.id - a.id);
                updateDashboardMetrics();
                showSection(editId ? 'unit-search' : 'permits');
                showToast(`Permit ${editId ? 'updated' : 'saved'} successfully!`);
                await resetForm();
            } catch (error) {
                console.error('Error saving permit:', error);
                showToast('Error saving permit.', 'error');
            } finally {
                hideLoadingSpinner();
            }
        };

        const setupReportSection = () => {
            document.getElementById('reportForm').classList.toggle('hidden', isAdmin());
            document.getElementById('adminAuth').classList.toggle('hidden', isAdmin());
            document.getElementById('adminIssues').classList.toggle('hidden', !isAdmin());
            if (isAdmin()) loadIssuesTable();
            document.getElementById('charCount').textContent = `${document.getElementById('issueDescription').value.length}/500`;
        };

        const updateCharCount = () => {
            document.getElementById('charCount').textContent = `${document.getElementById('issueDescription').value.length}/500`;
        };

        const submitIssue = async (event) => {
            event.preventDefault();
            const data = {
                reportedBy: document.getElementById('reportUsername').value.trim(),
                description: document.getElementById('issueDescription').value.trim(),
                status: 'open',
                createdAt: formatLocalDate(new Date())
            };
            if (!data.reportedBy || !data.description) return showToast('Name and description required.', 'error');

            showLoadingSpinner();
            try {
                const transaction = db.transaction(['issues'], 'readwrite');
                const store = transaction.objectStore('issues');
                data.id = await new Promise((resolve, reject) => {
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                issues.push(data);
                document.getElementById('issueForm').reset();
                updateCharCount();
                updateDashboardMetrics();
                if (isAdmin()) loadIssuesTable();
                showToast('Issue reported successfully!');
            } catch (error) {
                console.error('Error reporting issue:', error);
                showToast('Error reporting issue.', 'error');
            } finally {
                hideLoadingSpinner();
            }
        };

        const loginAsAdmin = () => {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                localStorage.setItem('isAdmin', 'true');
                setupReportSection();
                showToast('Admin login successful.');
            } else {
                showToast('Incorrect password.', 'error');
            }
        };

        const loadIssuesTable = () => {
            document.getElementById('issuesTableBody').innerHTML = issues.map(i => `
                <tr>
                    <td>${i.id}</td>
                    <td>${i.reportedBy}</td>
                    <td>${i.description}</td>
                    <td><span class="status ${i.status === 'solved' ? 'active' : 'expired'}">${i.status === 'solved' ? 'Solved' : 'Open'}</span></td>
                    <td>${i.status !== 'solved' ? `<button class="btn-primary" onclick="markIssueSolved(${i.id})"><i class="fas fa-check"></i> Mark as Solved</button>` : ''}</td>
                </tr>
            `).join('');
        };

        const markIssueSolved = async (issueId) => {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;
            issue.status = 'solved';
            showLoadingSpinner();
            try {
                const transaction = db.transaction(['issues'], 'readwrite');
                const store = transaction.objectStore('issues');
                await new Promise((resolve, reject) => {
                    const request = store.put(issue);
                    request.onsuccess = resolve;
                    request.onerror = () => reject(request.error);
                });
                updateDashboardMetrics();
                loadIssuesTable();
                showToast('Issue marked as solved.');
            } catch (error) {
                console.error('Error marking issue solved:', error);
                showToast('Error marking issue solved.', 'error');
            } finally {
                hideLoadingSpinner();
            }
        };

        const clearSolvedIssues = async () => {
            if (!confirm('Clear all solved issues?')) return;
            showLoadingSpinner();
            try {
                const unsolved = issues.filter(i => i.status !== 'solved');
                const transaction = db.transaction(['issues'], 'readwrite');
                const store = transaction.objectStore('issues');
                await new Promise((resolve, reject) => {
                    const request = store.clear();
                    request.onsuccess = resolve;
                    request.onerror = () => reject(request.error);
                });
                await Promise.all(unsolved.map(i => new Promise((res, rej) => {
                    const req = transaction.objectStore('issues').add(i);
                    req.onsuccess = res;
                    req.onerror = () => rej(req.error);
                })));
                issues = unsolved;
                updateDashboardMetrics();
                loadIssuesTable();
                showToast('Solved issues cleared.');
            } catch (error) {
                console.error('Error clearing solved issues:', error);
                showToast('Error clearing solved issues.', 'error');
            } finally {
                hideLoadingSpinner();
            }
        };

        const displayUpdates = () => {
            document.getElementById('updatesList').innerHTML = updates.length ? updates.map(u => `
                <div class="update-item">
                    <p>${u.message}</p>
                    <span>${u.createdAt}</span>
                </div>
            `).join('') : '<p>No updates available.</p>';
        };

        const exportData = async () => {
            const data = { permits, issues, updates };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RainbowParkingData_${formatLocalDate(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
        };

        const importData = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            showLoadingSpinner();
            try {
                const text = await file.text();
                const { permits: newPermits, issues: newIssues, updates: newUpdates } = JSON.parse(text);
                const transactions = ['permits', 'issues', 'updates'].map(storeName => db.transaction([storeName], 'readwrite'));
                await Promise.all([
                    ...newPermits.map(p => new Promise((res, rej) => {
                        const req = transactions[0].objectStore('permits').put(p);
                        req.onsuccess = res;
                        req.onerror = () => rej(req.error);
                    })),
                    ...newIssues.map(i => new Promise((res, rej) => {
                        const req = transactions[1].objectStore('issues').put(i);
                        req.onsuccess = res;
                        req.onerror = () => rej(req.error);
                    })),
                    ...newUpdates.map(u => new Promise((res, rej) => {
                        const req = transactions[2].objectStore('updates').put(u);
                        req.onsuccess = res;
                        req.onerror = () => rej(req.error);
                    }))
                ]);
                permits = newPermits;
                issues = newIssues;
                updates = newUpdates;
                filteredPermits = [...permits].sort((a, b) => b.id - a.id);
                updateDashboardMetrics();
                if (isAdmin()) loadIssuesTable();
                displayUpdates();
                showToast('Data imported successfully!');
            } catch (error) {
                console.error('Error importing data:', error);
                showToast('Error importing data.', 'error');
            } finally {
                hideLoadingSpinner();
                document.getElementById('importFileInput').value = '';
            }
        };

        // Initialization
        (async () => {
            try {
                db = await openDatabase();
                await Promise.all([loadPermitsFromDB(), loadIssuesFromDB(), loadUpdatesFromDB()]);
                filteredPermits = [...permits].sort((a, b) => b.id - a.id);
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize. Please refresh.', 'error');
            }
        })();

        // Event Listeners
        document.querySelectorAll('[data-section]').forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.section)));
        document.getElementById('refreshMetricsBtn').addEventListener('click', () => { updateDashboardMetrics(); showToast('Metrics refreshed!'); });
        document.getElementById('permitForm').addEventListener('submit', submitPermit);
        document.getElementById('unitNo').addEventListener('input', checkUnit);
        document.getElementById('issueDate').addEventListener('change', checkUnit);
        document.getElementById('resetFormBtn').addEventListener('click', resetForm);
        document.getElementById('searchPermits').addEventListener('input', searchPermits);
        document.getElementById('searchFilter').addEventListener('change', searchPermits);
        document.getElementById('unitSearchInput').addEventListener('input', checkRemainingPermits);
        document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
        document.getElementById('prevPageBtn').addEventListener('click', prevPage);
        document.getElementById('nextPageBtn').addEventListener('click', nextPage);
        document.getElementById('issueForm').addEventListener('submit', submitIssue);
        document.getElementById('issueDescription').addEventListener('input', updateCharCount);
        document.getElementById('adminLoginBtn').addEventListener('click', loginAsAdmin);
        document.getElementById('clearSolvedBtn').addEventListener('click', clearSolvedIssues);
        document.getElementById('exportDataBtn').addEventListener('click', exportData);
        document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
        document.getElementById('importFileInput').addEventListener('change', importData);
    </script>
</body>
</html>
