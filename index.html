<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow Parking System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="loadingSpinner" class="spinner hidden">
        <i class="fas fa-spinner fa-spin"></i>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1><i class="fas fa-parking"></i> Rainbow Village Parking</h1>
            </div>
            <div class="system-label">Security Management System</div>
        </div>
    </header>

    <div class="layout">
        <aside class="sidebar">
    <nav class="sidebar-menu">
        <button class="active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
        <button onclick="showSection('permits')"><i class="fas fa-ticket-alt"></i> Add Permit</button>
        <button onclick="showSection('unit-search')"><i class="fas fa-search"></i> Permit Record</button>
        <button onclick="showSection('report')"><i class="fas fa-exclamation-circle"></i> Report Issue</button>
        <button onclick="showSection('about')"><i class="fas fa-info-circle"></i> About</button>
        <button onclick="window.location.href='index2.html'"><i class="fas fa-book"></i> Site Rules</button>
        <!-- New Generate Report Button -->
        <button onclick="window.location.href='report-generator.html'"><i class="fas fa-file-pdf"></i> Generate Report</button>
    </nav>
    <div class="copyright">© 2025 Jagroop Singh<br>All rights reserved</div>
</aside>

        <main class="main-content">
            <section id="dashboard" class="section active">
                <div class="container">
                    <div class="section-header">
                        <h2>Dashboard</h2>
                        <button class="btn-secondary" onclick="refreshMetrics()"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card" title="Total number of permits issued">
                            <i class="fas fa-ticket-alt"></i>
                            <h3>Total Permits</h3>
                            <p id="totalPermits" class="count-up">0</p>
                        </div>
                        <div class="metric-card" title="Permits issued today">
                            <i class="fas fa-ticket-alt"></i>
                            <h3>Today's Permits</h3>
                            <p id="todayPermits" class="count-up">0</p>
                        </div>
                        <div class="metric-card" title="Unresolved issues">
                            <i class="fas fa-exclamation-circle"></i>
                            <h3>Open Issues</h3>
                            <p id="openIssues" class="count-up">0</p>
                        </div>
                    </div>
                    <div class="updates-section">
                        <h3>Latest Updates</h3>
                        <div id="updatesList" class="updates-list">
                            <div class="update-item">
                                <p>Welcome to the new parking system for Rainbow Village.</p>
                                <span>04/01/2025 - Admin</span>
                            </div>
                        </div>
                    </div>
                    <div class="nav-grid">
                        <div class="nav-card" onclick="showSection('permits')">
                            <i class="fas fa-ticket-alt"></i>
                            <h3>Permit Management</h3>
                            <p>Add new visitor parking permits</p>
                        </div>
                        <div class="nav-card" onclick="showSection('unit-search')">
                            <i class="fas fa-search"></i>
                            <h3>Unit Search</h3>
                            <p>Search permits and check remaining permits</p>
                        </div>
                        <div class="nav-card" onclick="showSection('report')">
                            <i class="fas fa-exclamation-circle"></i>
                            <h3>Report Issue</h3>
                            <p>Report problems with the parking system</p>
                        </div>
                        <div class="nav-card" onclick="showSection('about')">
                            <i class="fas fa-info-circle"></i>
                            <h3>About</h3>
                            <p>Information about the parking management system</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="permits" class="section hidden">
                <div class="container">
                    <h2>Permit Management</h2>
                    <p>Add new visitor parking permits with ease</p>
                    <div class="permit-actions">
                        <button class="btn-primary" onclick="showSection('form')"><i class="fas fa-plus"></i> Add New Permit</button>
                    </div>
                </div>
            </section>

            <section id="form" class="section hidden">
                <div class="container">
                    <div class="form-container">
                        <div class="form-header">
                            <h3 id="formTitle">Add New Parking Permit</h3>
                            <button onclick="showSection('permits')"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="formError" class="error hidden"></div>
                        <div id="formRemaining" class="info hidden"></div>
                        <form id="permitForm" onsubmit="submitPermit(event)">
                            <input type="hidden" id="editPermitId">
                            <div class="grid form-grid">
                                <div>
                                    <label>Permit No. <span class="tooltip" title="Auto-generated">ℹ</span></label>
                                    <input type="text" id="permitNo" readonly>
                                </div>
                                <div>
                                    <label>Unit No.</label>
                                    <input type="text" id="unitNo" placeholder="1234/A" pattern="^\d{4}/[A-Z]$" required oninput="checkUnit()">
                                </div>
                                <div>
                                    <label>Visitor Name</label>
                                    <input type="text" id="visitorName" required>
                                </div>
                                <div>
                                    <label>License Plate</label>
                                    <input type="text" id="licensePlate" required>
                                </div>
                                <div>
                                    <label>Vehicle Make</label>
                                    <select id="vehicleMake" required>
                                        <option value="">Select Make</option>
                                        <option value="Toyota">Toyota</option>
                                        <option value="Honda">Honda</option>
                                        <option value="Ford">Ford</option>
                                        <option value="BMW">BMW</option>
                                        <option value="Mercedes">Mercedes</option>
                                        <option value="Tesla">Tesla</option>
                                        <option value="Volkswagen">Volkswagen</option>
                                        <option value="Hyundai">Hyundai</option>
                                        <option value="Chevrolet">Chevrolet</option>
                                        <option value="Nissan">Nissan</option>
                                        <option value="Audi">Audi</option>
                                        <option value="Kia">Kia</option>
                                        <option value="Subaru">Subaru</option>
                                        <option value="Mazda">Mazda</option>
                                        <option value="Jeep">Jeep</option>
                                        <option value="Porsche">Porsche</option>
                                        <option value="Lexus">Lexus</option>
                                        <option value="Volvo">Volvo</option>
                                        <option value="Dodge">Dodge</option>
                                        <option value="Ram">Ram</option>
                                        <option value="GMC">GMC</option>
                                        <option value="Acura">Acura</option>
                                        <option value="Infiniti">Infiniti</option>
                                        <option value="Mitsubishi">Mitsubishi</option>
                                        <option value="Land Rover">Land Rover</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Vehicle Color</label>
                                    <select id="vehicleColor" required>
                                        <option value="">Select Color</option>
                                        <option value="Black">Black</option>
                                        <option value="White">White</option>
                                        <option value="Silver">Silver</option>
                                        <option value="Blue">Blue</option>
                                        <option value="Red">Red</option>
                                        <option value="Green">Green</option>
                                        <option value="Yellow">Yellow</option>
                                        <option value="Gray">Gray</option>
                                        <option value="Orange">Orange</option>
                                        <option value="Purple">Purple</option>
                                        <option value="Brown">Brown</option>
                                        <option value="Beige">Beige</option>
                                        <option value="Gold">Gold</option>
                                        <option value="Bronze">Bronze</option>
                                        <option value="Pink">Pink</option>
                                        <option value="Teal">Teal</option>
                                        <option value="Metallic Blue">Metallic Blue</option>
                                        <option value="Pearl White">Pearl White</option>
                                        <option value="Matte Black">Matte Black</option>
                                        <option value="Charcoal">Charcoal</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Issue Officer</label>
                                    <select id="issueOfficer" required>
                                        <option value="">Select Officer</option>
                                        <option value="Jagroop">Jagroop</option>
                                        <option value="Melbin">Melbin</option>
                                        <option value="Kartik">Kartik</option>
                                        <option value="Abiy">Abiy</option>
                                        <option value="Zamil">Zamil</option>
                                        <option value="Abir">Abir</option>
                                        <option value="Bhupinder">Bhupinder</option>
                                        <option value="Priotosh">Priotosh</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Issue Date</label>
                                    <input type="date" id="issueDate" required>
                                </div>
                                <div>
                                    <label>Expire Date</label>
                                    <input type="date" id="expireDate" required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" onclick="resetForm()">Reset</button>
                                <button type="button" onclick="showSection('permits')">Cancel</button>
                                <button type="submit" id="savePermitBtn">Save Permit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <section id="unit-search" class="section hidden">
                <div class="container">
                    <h2>Unit Search</h2>
                    <p>Search for permits or check remaining permits for specific units</p>
                    <div class="grid">
                        <div class="search-group">
                            <label>Search Permits</label>
                            <div class="search-bar">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchPermits" placeholder="Search by any field..." oninput="searchPermits()">
                            </div>
                        </div>
                        <div class="search-group">
                            <label>Check Remaining Permits</label>
                            <div class="search-bar">
                                <i class="fas fa-search"></i>
                                <input type="text" id="unitSearchInput" placeholder="Unit No. (e.g., 1234/A)" oninput="checkRemainingPermits()">
                            </div>
                            <div id="unitSearchResult" class="info hidden"></div>
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn-secondary" onclick="clearSearch()"><i class="fas fa-times"></i> Clear Search</button>
                    </div>
                    <div id="searchResults" class="table-container hidden">
                        <table id="permitsTable">
                            <thead>
                                <tr>
                                    <th>Permit Details</th>
                                    <th>Vehicle Info</th>
                                    <th>Dates</th>
                                    <th>Officer</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="permitsTableBody"></tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="prevPage()" id="prevPageBtn" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                            <span id="pageInfo">Page 1</span>
                            <button onclick="nextPage()" id="nextPageBtn">Next <i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="report" class="section hidden">
                <div class="container">
                    <h2>Report an Issue</h2>
                    <div id="reportForm">
                        <p>Encountered a problem? Submit your issue below:</p>
                        <form id="issueForm" onsubmit="submitIssue(event)">
                            <div class="search-group">
                                <label>Your Name</label>
                                <input type="text" id="reportUsername" placeholder="Enter your name" required>
                            </div>
                            <div class="search-group">
                                <label>Issue Description <span id="charCount">0/500</span></label>
                                <textarea id="issueDescription" placeholder="Describe the issue..." maxlength="500" required oninput="updateCharCount()"></textarea>
                            </div>
                            <button class="btn-primary" type="submit"><i class="fas fa-paper-plane"></i> Submit Issue</button>
                        </form>
                    </div>
                    <div id="adminAuth" class="hidden">
                        <p>Enter admin password to view and manage issues:</p>
                        <div class="search-group">
                            <label>Admin Password</label>
                            <input type="password" id="adminPassword" placeholder="Enter admin password">
                        </div>
                        <button class="btn-primary" onclick="loginAsAdmin()"><i class="fas fa-lock"></i> Login as Admin</button>
                    </div>
                    <div id="adminIssues" class="table-container hidden">
                        <div class="section-header">
                            <h3>Reported Issues (Admin View)</h3>
                            <button class="btn-secondary" onclick="clearSolvedIssues()"><i class="fas fa-trash"></i> Clear Solved Issues</button>
                        </div>
                        <table id="issuesTable">
                            <thead>
                                <tr>
                                    <th>Issue ID</th>
                                    <th>Reported By</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="issuesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="about" class="section hidden">
                <div class="container">
                    <h2>About Rainbow Parking System</h2>
                    <p>Welcome to the <strong>Rainbow Parking System</strong>, an innovative and user-friendly platform crafted to revolutionize visitor parking management at Rainbow Village. Developed with precision and care, this system empowers the community’s security team to issue permits, track usage, and resolve issues seamlessly, ensuring a smooth parking experience for all residents and visitors alike.</p>
                    <h3>What We Offer</h3>
                    <p>The Rainbow Parking System is more than just a tool—it’s a complete solution designed to bring order and efficiency to community parking. Here’s a glimpse of what makes this platform stand out:</p>
                    <ul class="feature-list">
                        <li><strong>Automated Permit Issuance</strong>: Quickly generate visitor parking permits with unique permit numbers.</li>
                        <li><strong>Unit-Based Tracking</strong>: Monitor permit allocations per unit, with a cap of 7 permits per month for fairness.</li>
                        <li><strong>Search & Insights</strong>: Easily search permits by any detail and check remaining permits per unit in real-time.</li>
                        <li><strong>Issue Reporting</strong>: A dedicated system for residents and security to report and resolve parking-related concerns.</li>
                        <li><strong>Admin Control</strong>: Secure admin features for managing updates and issues, accessible only to authorized personnel.</li>
                        <li><strong>Persistent Data</strong>: Powered by IndexedDB, ensuring all data is safely stored and accessible across sessions.</li>
                    </ul>
                    <div class="fancy-note">
                        <p>© All rights reserved by Jagroop Singh. Crafted and donated as a voluntary initiative for the Rainbow Village community.</p>
                        <p>For inquiries, feedback, or issues, please connect with Jagroop Singh directly during his visits to the village.</p>
                        <p>A proud creation of Punjab Production</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="toast" class="toast hidden">
        <i id="toastIcon" class="fas"></i>
        <span id="toastMessage"></span>
    </div>

    <script>
        let db;
        let permits = [];
        let issues = [];
        let updates = [];
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        const ADMIN_PASSWORD = "3343"; // TODO: Replace with secure storage in production
        const ITEMS_PER_PAGE = 5;
        let currentPage = 1;
        let filteredPermits = [];
        const MAX_PERMITS_PER_UNIT_PER_MONTH = 7;

        const request = indexedDB.open('ParkingDB', 4);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains('permits')) {
                const permitStore = db.createObjectStore('permits', { keyPath: 'id', autoIncrement: true });
                permitStore.createIndex('permitNo', 'permitNo', { unique: true });
                permitStore.createIndex('licensePlate', 'licensePlate', { unique: false });
                permitStore.createIndex('unitNo', 'unitNo', { unique: false });
                permitStore.createIndex('issueMonth', 'issueMonth', { unique: false });
            }
            if (!db.objectStoreNames.contains('issues')) {
                db.createObjectStore('issues', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('updates')) {
                db.createObjectStore('updates', { keyPath: 'id', autoIncrement: true });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            loadPermitsFromDB();
            loadIssuesFromDB();
            loadUpdatesFromDB();
            filteredPermits = permits.slice().sort((a, b) => b.id - a.id);
        };

        request.onerror = function(event) {
            console.error('IndexedDB error:', event.target.errorCode);
            showToast(`Database error: ${event.target.errorCode}. Retrying in 5 seconds...`, 'error');
            setTimeout(() => location.reload(), 5000);
        };

        // Removed auto-reload to prevent interruptions
        // Added manual sync option in the dashboard if needed

        // Format date for storage (YYYY-MM-DD)
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Parse date string (YYYY-MM-DD) to Date object in local time
        function parseDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // Get end of day for a date (23:59:59)
        function getEndOfDay(date) {
            const endOfDay = new Date(date);
            endOfDay.setHours(23, 59, 59, 999);
            return endOfDay;
        }

        // Format date for display (MM/DD/YYYY)
        function displayDate(dateStr) {
            const date = parseDate(dateStr);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }

        function showLoadingSpinner() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function loadPermitsFromDB() {
            showLoadingSpinner();
            try {
                const transaction = db.transaction(['permits'], 'readonly');
                const store = transaction.objectStore('permits');
                const request = store.getAll();

                request.onsuccess = function() {
                    permits = request.result.length ? request.result.sort((a, b) => b.id - a.id) : [];
                    // Only add sample data if the database is empty
                    if (!permits.length) {
                        const now = new Date();
                        const samplePermit = { 
                            id: 1, 
                            permitNo: "P001", 
                            unitNo: "1234/A", 
                            visitorName: "John Doe", 
                            licensePlate: "ABC123", 
                            vehicleMake: "Toyota", 
                            vehicleColor: "Blue", 
                            issueDate: "2025-03-01", // Hardcode to prevent date shifts
                            expireDate: "2025-03-31", // Hardcode to prevent date shifts
                            issueOfficer: "Jagroop", 
                            issueMonth: "2025-03" 
                        };
                        permits.push(samplePermit);
                        const writeTransaction = db.transaction(['permits'], 'readwrite');
                        const writeStore = writeTransaction.objectStore('permits');
                        permits.forEach(permit => writeStore.add(permit));
                    }
                    updateDashboardMetrics();
                    hideLoadingSpinner();
                };

                request.onerror = function() {
                    throw new Error('Failed to load permits');
                };
            } catch (error) {
                console.error(error);
                showToast('Error loading permits. Using fallback data.', 'error');
                permits = [
                    { 
                        id: 1, 
                        permitNo: "P001", 
                        unitNo: "1234/A", 
                        visitorName: "John Doe", 
                        licensePlate: "ABC123", 
                        vehicleMake: "Toyota", 
                        vehicleColor: "Blue", 
                        issueDate: "2025-03-01", 
                        expireDate: "2025-03-31", 
                        issueOfficer: "Jagroop", 
                        issueMonth: "2025-03" 
                    }
                ];
                updateDashboardMetrics();
                hideLoadingSpinner();
            }
        }

        function loadIssuesFromDB() {
            showLoadingSpinner();
            try {
                const transaction = db.transaction(['issues'], 'readonly');
                const store = transaction.objectStore('issues');
                const request = store.getAll();

                request.onsuccess = function() {
                    issues = request.result;
                    updateDashboardMetrics();
                    if (isAdmin) loadIssuesTable();
                    hideLoadingSpinner();
                };

                request.onerror = function() {
                    throw new Error('Failed to load issues');
                };
            } catch (error) {
                console.error(error);
                showToast('Error loading issues.', 'error');
                hideLoadingSpinner();
            }
        }

        function loadUpdatesFromDB() {
            showLoadingSpinner();
            try {
                const transaction = db.transaction(['updates'], 'readonly');
                const store = transaction.objectStore('updates');
                const request = store.getAll();

                request.onsuccess = function() {
                    updates = request.result;
                    if (!updates.length) {
                        const updatesList = document.getElementById('updatesList');
                        const updateItems = updatesList.getElementsByClassName('update-item');
                        updates = Array.from(updateItems).map((item, index) => ({
                            id: index + 1,
                            message: item.querySelector('p').textContent,
                            createdAt: item.querySelector('span').textContent
                        }));
                        const writeTransaction = db.transaction(['updates'], 'readwrite');
                        const writeStore = writeTransaction.objectStore('updates');
                        updates.forEach(update => writeStore.add(update));
                    }
                    displayUpdates();
                    hideLoadingSpinner();
                };

                request.onerror = function() {
                    throw new Error('Failed to load updates');
                };
            } catch (error) {
                console.error(error);
                showToast('Error loading updates.', 'error');
                hideLoadingSpinner();
            }
        }

        function updateDashboardMetrics() {
            const now = new Date();
            const todayStr = formatDate(now);
            const totalPermits = permits.length;
            const todayPermits = permits.filter(p => p.issueDate === todayStr).length;
            const openIssues = issues.filter(i => i.status !== 'solved').length;

            animateCount('totalPermits', totalPermits);
            animateCount('todayPermits', todayPermits);
            animateCount('openIssues', openIssues);
        }

        function animateCount(elementId, target) {
            const element = document.getElementById(elementId);
            let start = parseInt(element.textContent) || 0;
            const duration = 1000;
            const increment = (target - start) / (duration / 60);
            const interval = setInterval(() => {
                start += increment;
                if (increment > 0 ? start >= target : start <= target) {
                    start = target;
                    clearInterval(interval);
                }
                element.textContent = Math.round(start);
            }, 60);
        }

        function refreshMetrics() {
            showLoadingSpinner();
            updateDashboardMetrics();
            showToast('Metrics refreshed successfully!');
            hideLoadingSpinner();
        }

        function updatePermitNo() {
            const permitNo = `P${getNextPermitNo()}`;
            document.getElementById('permitNo').value = permitNo;
            const now = new Date();
            document.getElementById('issueDate').value = formatDate(now);
            document.getElementById('expireDate').value = formatDate(new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000));
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            if (sectionId === 'form') {
                if (!document.getElementById('editPermitId').value) {
                    updatePermitNo();
                    document.getElementById('formTitle').textContent = 'Add New Parking Permit';
                }
            }
            if (sectionId === 'unit-search') {
                currentPage = 1;
                searchPermits();
            }
            if (sectionId === 'report') setupReportSection();
            if (sectionId === 'dashboard') displayUpdates();
            document.querySelectorAll('.sidebar-menu button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.sidebar-menu button[onclick="showSection('${sectionId}')"]`)?.classList.add('active');
        }

        function getNextPermitNo() {
            if (!permits.length) return "001";
            const maxPermitNo = Math.max(...permits.map(p => parseInt(p.permitNo.slice(1)) || 0));
            return String(maxPermitNo + 1).padStart(3, '0');
        }

        function searchPermits() {
            try {
                const query = document.getElementById('searchPermits').value.toLowerCase().trim();
                filteredPermits = permits.filter(p => 
                    (p.permitNo || '').toLowerCase().includes(query) ||
                    (p.unitNo || '').toLowerCase().includes(query) ||
                    (p.visitorName || '').toLowerCase().includes(query) ||
                    (p.licensePlate || '').toLowerCase().includes(query) ||
                    (p.vehicleMake || '').toLowerCase().includes(query) ||
                    (p.vehicleColor || '').toLowerCase().includes(query) ||
                    (p.issueOfficer || '').toLowerCase().includes(query)
                ).sort((a, b) => b.id - a.id);
                currentPage = 1;
                loadSearchResults();
            } catch (error) {
                console.error(error);
                showToast('Error searching permits.', 'error');
            }
        }

        function loadSearchResults() {
            try {
                const now = new Date();
                const start = (currentPage - 1) * ITEMS_PER_PAGE;
                const end = start + ITEMS_PER_PAGE;
                const paginatedPermits = filteredPermits.slice(start, end);

                const tableBody = document.getElementById('permitsTableBody');
                tableBody.innerHTML = paginatedPermits.map(p => {
                    const issueDate = parseDate(p.issueDate);
                    const expireDate = parseDate(p.expireDate);
                    const expireDateEndOfDay = getEndOfDay(expireDate); // Fix: Consider end of day for expiration
                    return `
                        <tr>
                            <td>${highlightText(p.permitNo, document.getElementById('searchPermits').value)}<br><span>${highlightText(p.visitorName, document.getElementById('searchPermits').value)} (${highlightText(p.unitNo, document.getElementById('searchPermits').value)})</span></td>
                            <td>${highlightText(p.licensePlate, document.getElementById('searchPermits').value)}<br><span>${highlightText(p.vehicleMake, document.getElementById('searchPermits').value)} - ${highlightText(p.vehicleColor, document.getElementById('searchPermits').value)}</span></td>
                            <td><i class="fas fa-calendar"></i> ${displayDate(p.issueDate)} - ${displayDate(p.expireDate)}</td>
                            <td>${highlightText(p.issueOfficer, document.getElementById('searchPermits').value)}</td>
                            <td><span class="status ${expireDateEndOfDay > now ? 'active' : 'expired'}">${expireDateEndOfDay > now ? 'Active' : 'Expired'}</span></td>
                            <td><button class="btn-primary" onclick="editPermit(${p.id})"><i class="fas fa-edit"></i> Edit</button></td>
                        </tr>
                    `;
                }).join('');

                const tableContainer = document.getElementById('searchResults');
                tableContainer.classList.toggle('hidden', !paginatedPermits.length);

                const totalPages = Math.ceil(filteredPermits.length / ITEMS_PER_PAGE);
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
                document.getElementById('prevPageBtn').disabled = currentPage === 1;
                document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
            } catch (error) {
                console.error(error);
                showToast('Error loading search results.', 'error');
            }
        }

        function highlightText(text, query) {
            if (!query || !text) return text || '';
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadSearchResults();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredPermits.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                loadSearchResults();
            }
        }

        function clearSearch() {
            document.getElementById('searchPermits').value = '';
            document.getElementById('unitSearchInput').value = '';
            document.getElementById('unitSearchResult').classList.add('hidden');
            filteredPermits = permits.slice().sort((a, b) => b.id - a.id);
            currentPage = 1;
            loadSearchResults();
        }

        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        function checkRemainingPermits() {
            const unitNo = document.getElementById('unitSearchInput').value.toUpperCase();
            const regex = /^\d{4}\/[A-Z]$/;
            const remainingDiv = document.getElementById('unitSearchResult');
            const currentMonth = getCurrentMonth();

            if (regex.test(unitNo)) {
                const monthlyPermits = permits.filter(p => p.unitNo.toUpperCase() === unitNo && p.issueMonth === currentMonth);
                const remaining = MAX_PERMITS_PER_UNIT_PER_MONTH - monthlyPermits.length;
                remainingDiv.textContent = `${remaining} permit${remaining !== 1 ? 's' : ''} remaining for ${currentMonth}`;
                remainingDiv.classList.remove('hidden');
            } else {
                remainingDiv.classList.add('hidden');
            }
        }

        function checkUnit() {
            const unitNo = document.getElementById('unitNo').value.toUpperCase();
            const regex = /^\d{4}\/[A-Z]$/;
            const remainingDiv = document.getElementById('formRemaining');
            const errorDiv = document.getElementById('formError');
            const submitBtn = document.getElementById('savePermitBtn');
            const unitInput = document.getElementById('unitNo');
            const issueDateStr = document.getElementById('issueDate').value;
            const issueDate = parseDate(issueDateStr);
            const currentMonth = `${issueDate.getFullYear()}-${String(issueDate.getMonth() + 1).padStart(2, '0')}`;
            const editPermitId = document.getElementById('editPermitId').value;

            if (regex.test(unitNo)) {
                const monthlyPermits = permits.filter(p => p.unitNo.toUpperCase() === unitNo && p.issueMonth === currentMonth && (!editPermitId || p.id != editPermitId));
                const remaining = MAX_PERMITS_PER_UNIT_PER_MONTH - monthlyPermits.length;
                remainingDiv.textContent = `This unit has ${remaining} permit${remaining !== 1 ? 's' : ''} remaining for ${currentMonth}`;
                remainingDiv.classList.remove('hidden');
                submitBtn.disabled = remaining <= 0 && !editPermitId;
                unitInput.classList.remove('invalid');
                errorDiv.classList.add('hidden');
                if (remaining <= 0 && !editPermitId) {
                    errorDiv.textContent = `Monthly permit limit reached for ${currentMonth}`;
                    errorDiv.classList.remove('hidden');
                }
            } else {
                remainingDiv.classList.add('hidden');
                submitBtn.disabled = true;
                errorDiv.textContent = 'Invalid unit number format (e.g., 1234/A)';
                errorDiv.classList.remove('hidden');
                unitInput.classList.add('invalid');
            }
        }

        function resetForm() {
            document.getElementById('permitForm').reset();
            document.getElementById('editPermitId').value = '';
            document.getElementById('formTitle').textContent = 'Add New Parking Permit';
            updatePermitNo();
            document.getElementById('formError').classList.add('hidden');
            document.getElementById('formRemaining').classList.add('hidden');
            document.getElementById('savePermitBtn').disabled = false;
            document.querySelectorAll('.form-grid input, .form-grid select').forEach(input => input.classList.remove('invalid'));
        }

        function editPermit(permitId) {
            const permit = permits.find(p => p.id === permitId);
            if (!permit) {
                showToast('Permit not found.', 'error');
                return;
            }

            document.getElementById('formTitle').textContent = 'Edit Parking Permit';
            document.getElementById('editPermitId').value = permit.id;
            document.getElementById('permitNo').value = permit.permitNo;
            document.getElementById('unitNo').value = permit.unitNo;
            document.getElementById('visitorName').value = permit.visitorName;
            document.getElementById('licensePlate').value = permit.licensePlate;
            document.getElementById('vehicleMake').value = permit.vehicleMake;
            document.getElementById('vehicleColor').value = permit.vehicleColor;
            document.getElementById('issueOfficer').value = permit.issueOfficer;
            document.getElementById('issueDate').value = permit.issueDate;
            document.getElementById('expireDate').value = permit.expireDate;

            checkUnit(); // Ensure validation is triggered after populating the form
            showSection('form');
        }

        function submitPermit(event) {
            event.preventDefault();
            try {
                const editPermitId = document.getElementById('editPermitId').value;
                const unitNo = document.getElementById('unitNo').value.toUpperCase();
                const licensePlate = document.getElementById('licensePlate').value.toUpperCase();
                const issueDateStr = document.getElementById('issueDate').value;
                const expireDateStr = document.getElementById('expireDate').value;
                const vehicleMake = document.getElementById('vehicleMake').value;
                const vehicleColor = document.getElementById('vehicleColor').value;
                const issueOfficer = document.getElementById('issueOfficer').value;
                const issueDate = parseDate(issueDateStr);
                const currentMonth = `${issueDate.getFullYear()}-${String(issueDate.getMonth() + 1).padStart(2, '0')}`;

                const form = document.getElementById('permitForm');
                let isValid = true;
                form.querySelectorAll('input[required], select[required]').forEach(input => {
                    if (!input.value.trim() || (input.tagName === 'SELECT' && input.value === '')) {
                        input.classList.add('invalid');
                        isValid = false;
                    } else {
                        input.classList.remove('invalid');
                    }
                });

                if (!isValid) {
                    showToast('All required fields must be filled.', 'error');
                    return;
                }

                if (!/^\d{4}\/[A-Z]$/.test(unitNo)) {
                    showToast('Unit number must be in format 1234/A.', 'error');
                    return;
                }

                if (licensePlate.length < 1 || licensePlate.length > 10) {
                    showToast('License plate must be 1-10 characters.', 'error');
                    return;
                }

                const expireDate = parseDate(expireDateStr);
                const expireDateEndOfDay = getEndOfDay(expireDate);

                const originalPermit = editPermitId ? permits.find(p => p.id == editPermitId) : null;
                if (!editPermitId || (editPermitId && originalPermit.unitNo !== unitNo)) {
                    const monthlyPermits = permits.filter(p => p.unitNo === unitNo && p.issueMonth === currentMonth && (!editPermitId || p.id != editPermitId));
                    if (monthlyPermits.length >= MAX_PERMITS_PER_UNIT_PER_MONTH) {
                        showToast(`Permit limit reached for ${unitNo} in ${currentMonth}.`, 'error');
                        return;
                    }
                }

                const existingPermit = permits.find(p => p.licensePlate === licensePlate && getEndOfDay(parseDate(p.expireDate)) > new Date() && (!editPermitId || p.id != editPermitId));
                if (existingPermit) {
                    showToast(`Active permit already exists for ${licensePlate}.`, 'error');
                    return;
                }

                if (issueDate >= expireDate) {
                    showToast('Expire date must be after issue date.', 'error');
                    return;
                }

                if (!confirm(`Confirm ${editPermitId ? 'update' : 'save'} permit for ${unitNo}?`)) return;

                const permitData = {
                    permitNo: document.getElementById('permitNo').value,
                    unitNo: unitNo,
                    visitorName: document.getElementById('visitorName').value.trim(),
                    licensePlate: licensePlate,
                    vehicleMake: vehicleMake,
                    vehicleColor: vehicleColor,
                    issueDate: issueDateStr,
                    expireDate: expireDateStr,
                    issueOfficer: issueOfficer,
                    issueMonth: currentMonth // Ensure issueMonth is updated
                };

                showLoadingSpinner();
                const transaction = db.transaction(['permits'], 'readwrite');
                const store = transaction.objectStore('permits');

                if (editPermitId) {
                    permitData.id = parseInt(editPermitId);
                    const request = store.put(permitData);

                    request.onsuccess = function() {
                        const index = permits.findIndex(p => p.id == editPermitId);
                        permits[index] = permitData;
                        permits.sort((a, b) => b.id - a.id);
                        filteredPermits = permits.slice().sort((a, b) => b.id - a.id);
                        showSection('unit-search');
                        updateDashboardMetrics();
                        showToast('Permit updated successfully!');
                        resetForm();
                        hideLoadingSpinner();
                    };

                    request.onerror = function() {
                        throw new Error('Failed to update permit');
                    };
                } else {
                    const request = store.add(permitData);

                    request.onsuccess = function() {
                        permitData.id = request.result;
                        permits.unshift(permitData);
                        filteredPermits = permits.slice().sort((a, b) => b.id - a.id);
                        showSection('permits');
                        updateDashboardMetrics();
                        showToast('Permit saved successfully!');
                        resetForm();
                        hideLoadingSpinner();
                    };

                    request.onerror = function() {
                        throw new Error('Failed to save permit');
                    };
                }
            } catch (error) {
                console.error(error);
                showToast('Error processing permit. Please try again.', 'error');
                hideLoadingSpinner();
            }
        }

        function setupReportSection() {
            document.getElementById('reportForm').classList.remove('hidden');
            if (isAdmin) {
                document.getElementById('adminAuth').classList.add('hidden');
                document.getElementById('adminIssues').classList.remove('hidden');
                loadIssuesTable();
            } else {
                document.getElementById('adminAuth').classList.remove('hidden');
                document.getElementById('adminIssues').classList.add('hidden');
            }
            updateCharCount();
        }

        function updateCharCount() {
            const textarea = document.getElementById('issueDescription');
            const charCount = document.getElementById('charCount');
            charCount.textContent = `${textarea.value.length}/500`;
        }

        function submitIssue(event) {
            event.preventDefault();
            try {
                const username = document.getElementById('reportUsername').value.trim();
                const description = document.getElementById('issueDescription').value.trim();

                if (!username || !description) {
                    showToast('Name and description are required.', 'error');
                    return;
                }

                const newIssue = {
                    reportedBy: username,
                    description: description,
                    status: 'open',
                    createdAt: formatDate(new Date())
                };

                showLoadingSpinner();
                const transaction = db.transaction(['issues'], 'readwrite');
                const store = transaction.objectStore('issues');
                const request = store.add(newIssue);

                request.onsuccess = function() {
                    newIssue.id = request.result;
                    issues.push(newIssue);
                    document.getElementById('reportUsername').value = '';
                    document.getElementById('issueDescription').value = '';
                    updateCharCount();
                    updateDashboardMetrics();
                    if (isAdmin) loadIssuesTable();
                    showToast('Issue reported successfully!');
                    hideLoadingSpinner();
                };

                request.onerror = function() {
                    throw new Error('Failed to report issue');
                };
            } catch (error) {
                console.error(error);
                showToast('Error reporting issue.', 'error');
                hideLoadingSpinner();
            }
        }

        function loginAsAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                document.getElementById('adminAuth').classList.add('hidden');
                document.getElementById('adminIssues').classList.remove('hidden');
                loadIssuesTable();
                showToast('Admin login successful.');
            } else {
                showToast('Incorrect admin password.', 'error');
            }
        }

        function loadIssuesTable() {
            try {
                const tableBody = document.getElementById('issuesTableBody');
                tableBody.innerHTML = issues.map(i => `
                    <tr>
                        <td>${i.id}</td>
                        <td>${i.reportedBy}</td>
                        <td>${i.description}</td>
                        <td><span class="status ${i.status === 'solved' ? 'active' : 'expired'}">${i.status === 'solved' ? 'Solved' : 'Open'}</span></td>
                        <td>
                            ${i.status !== 'solved' ? `<button class="btn-primary" onclick="markIssueSolved(${i.id})"><i class="fas fa-check"></i> Mark as Solved</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error(error);
                showToast('Error loading issues table.', 'error');
            }
        }

        function markIssueSolved(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;

            issue.status = 'solved';
            showLoadingSpinner();
            try {
                const transaction = db.transaction(['issues'], 'readwrite');
                const store = transaction.objectStore('issues');
                const request = store.put(issue);

                request.onsuccess = function() {
                    updateDashboardMetrics();
                    loadIssuesTable();
                    showToast('Issue marked as solved.');
                    hideLoadingSpinner();
                };

                request.onerror = function() {
                    throw new Error('Failed to mark issue as solved');
                };
            } catch (error) {
                console.error(error);
                showToast('Error marking issue as solved.', 'error');
                hideLoadingSpinner();
            }
        }

        function clearSolvedIssues() {
            if (!confirm('Are you sure you want to clear all solved issues?')) return;

            showLoadingSpinner();
            try {
                const unsolvedIssues = issues.filter(i => i.status !== 'solved');
                const transaction = db.transaction(['issues'], 'readwrite');
                const store = transaction.objectStore('issues');
                const clearRequest = store.clear();

                clearRequest.onsuccess = function() {
                    const reAddTransaction = db.transaction(['issues'], 'readwrite');
                    const reAddStore = reAddTransaction.objectStore('issues');
                    unsolvedIssues.forEach(issue => reAddStore.add(issue));
                    issues = unsolvedIssues;
                    updateDashboardMetrics();
                    loadIssuesTable();
                    showToast('Solved issues cleared successfully.');
                    hideLoadingSpinner();
                };

                clearRequest.onerror = function() {
                    throw new Error('Failed to clear solved issues');
                };
            } catch (error) {
                console.error(error);
                showToast('Error clearing solved issues.', 'error');
                hideLoadingSpinner();
            }
        }

        function displayUpdates() {
            try {
                const updatesList = document.getElementById('updatesList');
                if (updates.length) {
                    updatesList.innerHTML = updates.map(u => `
                        <div class="update-item">
                            <p>${u.message}</p>
                            <span>${u.createdAt}</span>
                        </div>
                    `).join('');
                } else {
                    updatesList.innerHTML = '<p>No updates available.</p>';
                }
            } catch (error) {
                console.error(error);
                showToast('Error displaying updates.', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toastIcon.className = `fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
